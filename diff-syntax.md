# 本项目使用的 diff 语法

这套 diff 语法名为 `area-diff`，基于 `git-diff` 修改而来，详细规则如下：

1. `data` 目录下的每一个文件称为一个**区划代码数据表**，简称**数据表**。数据表的每一行称为一条**区划代码记录**，简称**记录**。一条记录由**代码**和**名称**组成，由一个制表符 `\t` 隔开。每一条记录都与一定范围的区域相对应，称为**该记录对应的区域**；
1. `diff` 目录下的每一个文件称为一个**差异表**，包含相应的两个数据表中记录的差异，其中作为相对参考的数据表称为**源表**，与之相对的数据表称为**目标表**；
1. 差异表的原始内容是通过对相应的数据表执行 `git diff -U0 --no-index` 并去除无关行后得到的；
1. 差异表的每一行分为四种类型，由其首字符决定，分别为：**删除行** (`-`), **增加行** (`+`), **内部变更行** (`=`) 及**注释行**（其他字符）。其中删除行、增加行和内部变更行统称为**变更行**，每一变更行只与相应的数据表中的一条记录相对应，称为**该行的记录**；
1. 以下规则中所指的**变更行**是内容经过手动或自动修改的，未经修改的变更行不服从以下规则；
1. 变更行的原始内容**必须**位于其行首处。原始内容之后到行尾的内容称为该变更行的**属性**，属性具有确定的语法，用于说明该行的记录与相关记录所对应的区域的相交关系；
1. 删除（增加）行的记录位于源（目标）表中。删除（增加）行的属性，包含目标（源）表中所有**对应的区域与该行的记录对应的区域有交集**的同级记录（若有）或上一级记录（若没有这样的同级记录）；
1. 删除行的属性以字符 `>` 起始，后接一个或多个以字符 `,` 分隔的**记录选择器**。增加行的属性以字符 `<` 起始，其余部分的语法与删除行相同。内部变更行的属性语法，要么与删除行相同，要么与增加行相同；
1. 对于内部变更行，当其属性语法与删除行相同时，其记录位于源表中，而当其属性语法与增加行相同时，其记录位于目标表中。通过改变内部变更行的首字符，可得到与之对应的删除行或增加行。内部变更行的属性所包含的记录，是从其对应的删除行或增加行所包含的记录中去除该行自身的记录后的结果；
1. 记录选择器有四种类型，分别为：**指定名称**、**相同名称**、**相同代码**和**存疑**。
    - **指定名称**选择器的值为文本，选择名称与其值相同的，距离所在行的记录最近的记录；
    - **相同名称**选择器的值为单个字符 `#`，选择名称与所在行的记录相同的，距离所在行的记录最近的记录；
    - **相同代码**选择器的值为单个字符 `.`，选择代码与所在行的记录相同的记录；
    - **存疑**选择器的值由前三种选择器中一种的值后接一**存疑标志**构成，其选择的记录依情况而定。存疑标志的可用值为单个字符 `?` 和 `!`，其中 `?` 指示该选择器无效并会将其禁用，一般用于找不到相关记录时，而 `!` 指示该选择器有效，一般用于能找到相关记录，且有充分的理由启用该选择器，但没有官方解释时。
